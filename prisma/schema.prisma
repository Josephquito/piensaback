generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =======================
// ENUMS
// =======================

enum BaseRole {
  SUPERADMIN
  ADMIN
  EMPLOYEE
}

enum UserStatus {
  ACTIVE
  INACTIVE
  BLOCKED
}

enum CompanyStatus {
  ACTIVE
  INACTIVE
  PENDING_DELETE
}

enum CompanyUserStatus {
  ACTIVE
  INACTIVE
}

/**
 * Permisos: acción CRUD
 */
enum PermissionAction {
  CREATE
  READ
  UPDATE
  DELETE
}

/**
 * Recursos (enum para evitar typos)
 */
enum PermissionResource {
  USERS
  PERMISSIONS
  COMPANIES

  SUPPLIERS
  CUSTOMERS
  PRODUCTS

  ACCOUNTS
  INVENTORY
  SLOTS
  SLOT_SALES
}

// =======================
// MODELS
// =======================

model User {
  id           Int        @id @default(autoincrement())
  email        String     @unique
  phone        String
  passwordHash String     @map("password_hash")
  nombre       String
  status       UserStatus @default(ACTIVE)

  // ✅ rol base global
  role         BaseRole   @default(EMPLOYEE) @map("base_role")

  // ✅ permisos globales asignados por usuario
  permissions  UserPermission[]

  // quién creó este usuario
  createdByUserId Int?   @map("created_by_user_id")
  createdBy       User?  @relation("UserCreator", fields: [createdByUserId], references: [id], onDelete: SetNull)
  createdUsers    User[] @relation("UserCreator")

  // cascade inactivation (tu lógica actual)
  cascadeInactivatedByUserId Int?   @map("cascade_inactivated_by_user_id")
  cascadeInactivatedBy       User?  @relation("UserCascadeInactivator", fields: [cascadeInactivatedByUserId], references: [id], onDelete: SetNull)
  cascadeInactivatedUsers    User[] @relation("UserCascadeInactivator")

  // companies donde es owner
  companies Company[] @relation("CompanyOwner")

  // memberships por empresa
  memberships CompanyUser[]

  // auditoría: delete workflow companies
  deleteRequestedCompanies Company[] @relation("CompanyDeleteRequestedBy")
  deleteConfirmedCompanies Company[] @relation("CompanyDeleteConfirmedBy")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  @@index([createdByUserId])
  @@index([role])
  @@index([status])
  @@map("users")
}

model Company {
  id          Int           @id @default(autoincrement())
  ownerUserId Int           @map("owner_user_id")
  name        String
  phone       String
  status      CompanyStatus @default(ACTIVE)

  // workflow delete (admin solicita, superadmin confirma)
  deleteRequestedAt     DateTime? @map("delete_requested_at")
  deleteRequestedBy     Int?      @map("delete_requested_by")
  deleteRequestedByUser User?     @relation("CompanyDeleteRequestedBy", fields: [deleteRequestedBy], references: [id], onDelete: SetNull)

  deleteConfirmedAt     DateTime? @map("delete_confirmed_at")
  deleteConfirmedBy     Int?      @map("delete_confirmed_by")
  deleteConfirmedByUser User?     @relation("CompanyDeleteConfirmedBy", fields: [deleteConfirmedBy], references: [id], onDelete: SetNull)

  owner User @relation("CompanyOwner", fields: [ownerUserId], references: [id], onDelete: Restrict)
  users CompanyUser[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  @@map("companies")
}

model CompanyUser {
  id        Int               @id @default(autoincrement())
  companyId Int               @map("company_id")
  userId    Int               @map("user_id")
  status    CompanyUserStatus @default(ACTIVE)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([companyId, userId])
  @@index([userId])
  @@index([companyId])
  @@map("company_users")
}

// =======================
// PERMISSIONS (GLOBAL CATALOG)
// =======================

model Permission {
  id Int @id @default(autoincrement())

  resource PermissionResource
  action   PermissionAction
  key      String @unique // e.g. "SUPPLIERS:CREATE"

  group    String?
  label    String?
  order    Int?
  isSystem Boolean @default(true)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  users UserPermission[]

  @@unique([resource, action])
  @@index([resource])
  @@map("permissions")
}

// ✅ pivot global user ↔ permission
model UserPermission {
  userId       Int @map("user_id")
  permissionId Int @map("permission_id")

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([userId, permissionId])
  @@index([permissionId])
  @@map("user_permissions")
}
