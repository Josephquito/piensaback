generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =======================
// ENUMS
// =======================

enum BaseRole {
  SUPERADMIN
  ADMIN
  EMPLOYEE
}

enum UserStatus {
  ACTIVE
  INACTIVE
  BLOCKED
}

enum CompanyStatus {
  ACTIVE
  INACTIVE
}

enum CompanyUserStatus {
  ACTIVE
  INACTIVE
}

enum PermissionAction {
  CREATE
  READ
  UPDATE
  DELETE
}

enum PermissionResource {
  USERS
  PERMISSIONS
  COMPANIES
  SUPPLIERS
  CUSTOMERS

  STREAMING_PLATFORMS
  STREAMING_ACCOUNTS
  STREAMING_SALES
  KARDEX
}

enum StreamingAccountStatus {
  ACTIVE
  INACTIVE
}

enum AccountProfileStatus {
  AVAILABLE
  SOLD
  BLOCKED
}

enum SaleStatus {
  ACTIVE
  CANCELED
}

enum KardexType {
  IN
  OUT
  ADJUST
}

enum KardexRefType {
  ACCOUNT_PURCHASE     // IN al crear cuenta
  PROFILE_SALE         // OUT al vender perfil
  ACCOUNT_INACTIVATION // ADJUST OUT al inactivar cuenta
  PROFILE_ADJUST       // IN/ADJUST por cambio de profilesTotal
  MANUAL_ADJUST
}

// =======================
// MODELS
// =======================

model User {
  id           Int        @id @default(autoincrement())
  email        String     @unique
  phone        String
  passwordHash String     @map("password_hash")
  nombre       String
  status       UserStatus @default(ACTIVE)

  role         BaseRole   @default(EMPLOYEE) @map("base_role")

  permissions  UserPermission[]

  createdByUserId Int?   @map("created_by_user_id")
  createdBy       User?  @relation("UserCreator", fields: [createdByUserId], references: [id], onDelete: SetNull)
  createdUsers    User[] @relation("UserCreator")

  cascadeInactivatedByUserId Int?   @map("cascade_inactivated_by_user_id")
  cascadeInactivatedBy       User?  @relation("UserCascadeInactivator", fields: [cascadeInactivatedByUserId], references: [id], onDelete: SetNull)
  cascadeInactivatedUsers    User[] @relation("UserCascadeInactivator")

  companies    Company[]     @relation("CompanyOwner")
  memberships  CompanyUser[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  @@index([createdByUserId])
  @@index([role])
  @@index([status])
  @@map("users")
}

model Company {
  id          Int           @id @default(autoincrement())
  ownerUserId Int           @map("owner_user_id")
  name        String
  phone       String
  status      CompanyStatus @default(ACTIVE)

  owner User @relation("CompanyOwner", fields: [ownerUserId], references: [id], onDelete: Restrict)

  users      CompanyUser[]
  suppliers  Supplier[]
  customers  Customer[]

  streamingAccounts StreamingAccount[]
  streamingSales    StreamingSale[]
  costItems         CostItem[]
  kardexMovements   KardexMovement[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  @@index([ownerUserId])
  @@index([status])
  @@map("companies")
  streamingPlatforms StreamingPlatform[]
}

model CompanyUser {
  id        Int               @id @default(autoincrement())
  companyId Int               @map("company_id")
  userId    Int               @map("user_id")
  status    CompanyUserStatus @default(ACTIVE)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([companyId, userId])
  @@index([userId])
  @@index([companyId])
  @@map("company_users")
}

model Permission {
  id Int @id @default(autoincrement())

  resource PermissionResource
  action   PermissionAction
  key      String @unique

  group    String?
  label    String?
  order    Int?
  isSystem Boolean @default(true)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  users UserPermission[]
  roles RolePermission[]

  @@index([resource])
  @@map("permissions")
}

model UserPermission {
  userId       Int @map("user_id")
  permissionId Int @map("permission_id")

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([userId, permissionId])
  @@index([permissionId])
  @@map("user_permissions")
}

model RolePermission {
  role         BaseRole @map("base_role")
  permissionId Int      @map("permission_id")

  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([role, permissionId])
  @@index([permissionId])
  @@index([role])
  @@map("role_permissions")
}

model Supplier {
  id        Int      @id @default(autoincrement())
  companyId Int      @map("company_id")
  name      String
  contact   String

  historicalSpend Decimal @db.Decimal(12, 4) @default(0) @map("historical_spend")

  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  accounts  StreamingAccount[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  @@index([companyId])
  @@unique([companyId, name])
  @@map("suppliers")
}


model Customer {
  id        Int      @id @default(autoincrement())
  companyId Int      @map("company_id")
  name      String
  contact   String
  source    String?

  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sales     StreamingSale[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  @@index([companyId])
  @@unique([companyId, name])
  @@map("customers")
}

// =======================
// STREAMING
// =======================

model StreamingPlatform {
  id        Int      @id @default(autoincrement())
  companyId Int      @map("company_id")

  name      String
  active    Boolean  @default(true)

  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  accounts  StreamingAccount[]
  costItems CostItem[]
  streamingSales StreamingSale[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  @@unique([companyId, name]) // âœ… nombres repetidos permitidos en otras empresas
  @@index([companyId])
  @@map("streaming_platforms")
}

model StreamingAccount {
  id         Int      @id @default(autoincrement())
  companyId  Int      @map("company_id")
  platformId Int      @map("platform_id")
  supplierId Int      @map("supplier_id")

  email         String
  password      String
  profilesTotal Int     @map("profiles_total")

  purchaseDate DateTime @map("purchase_date")
  cutoffDate   DateTime @map("cutoff_date")

  totalCost    Decimal  @db.Decimal(12, 4) @map("total_cost")

  notes  String?
  status StreamingAccountStatus @default(ACTIVE)

  company  Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  platform StreamingPlatform @relation(fields: [platformId], references: [id], onDelete: Restrict)
  supplier Supplier          @relation(fields: [supplierId], references: [id], onDelete: Restrict)

  profiles     AccountProfile[]
  kardexMoves  KardexMovement[]
  streamingSales StreamingSale[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  @@unique([companyId, platformId, email])
  @@index([companyId])
  @@index([platformId])
  @@index([supplierId])
  @@index([status])
  @@map("streaming_accounts")
}

model AccountProfile {
  id        Int      @id @default(autoincrement())
  accountId Int      @map("account_id")

  profileNo Int      @map("profile_no")
  status    AccountProfileStatus @default(AVAILABLE)

  account   StreamingAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  sales     StreamingSale[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  @@unique([accountId, profileNo])
  @@index([accountId])
  @@index([status])
  @@map("account_profiles")
}

model StreamingSale {
  id         Int      @id @default(autoincrement())
  companyId  Int      @map("company_id")
  platformId Int      @map("platform_id")

  accountId  Int      @map("account_id")
  profileId  Int      @map("profile_id")
  customerId Int      @map("customer_id")

  salePrice    Decimal  @db.Decimal(12, 4) @map("sale_price")
  saleDate     DateTime @map("sale_date")
  daysAssigned Int      @map("days_assigned")
  cutoffDate   DateTime @map("cutoff_date")

  costAtSale   Decimal  @db.Decimal(12, 4) @map("cost_at_sale")

  notes  String?
  status SaleStatus @default(ACTIVE)

  company  Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  platform StreamingPlatform @relation(fields: [platformId], references: [id], onDelete: Restrict)

  account  StreamingAccount  @relation(fields: [accountId], references: [id], onDelete: Restrict)
  profile  AccountProfile    @relation(fields: [profileId], references: [id], onDelete: Restrict)
  customer Customer          @relation(fields: [customerId], references: [id], onDelete: Restrict)

  kardexMoves KardexMovement[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  @@index([companyId])
  @@index([platformId])
  @@index([accountId])
  @@index([profileId])
  @@index([customerId])
  @@index([cutoffDate])
  @@index([status])
  @@map("streaming_sales")
}

// =======================
// KARDEX PONDERADO (por empresa + plataforma)
// =======================

model CostItem {
  id         Int @id @default(autoincrement())
  companyId  Int @map("company_id")
  platformId Int @map("platform_id")

  unit   String  @default("PROFILE")

  stock  Int     @default(0)
  avgCost Decimal @db.Decimal(12, 4) @map("avg_cost")

  company  Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  platform StreamingPlatform @relation(fields: [platformId], references: [id], onDelete: Restrict)

  movements KardexMovement[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  @@unique([companyId, platformId])
  @@index([companyId])
  @@index([platformId])
  @@map("cost_items")
}

model KardexMovement {
  id        Int @id @default(autoincrement())
  companyId Int @map("company_id")
  itemId    Int @map("item_id")

  type      KardexType
  refType   KardexRefType @map("ref_type")

  qty       Int
  unitCost  Decimal @db.Decimal(12, 4) @map("unit_cost")
  totalCost Decimal @db.Decimal(12, 4) @map("total_cost")

  stockAfter    Int     @map("stock_after")
  avgCostAfter  Decimal @db.Decimal(12, 4) @map("avg_cost_after")

  accountId Int? @map("account_id")
  saleId    Int? @map("sale_id")

  company Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  item    CostItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  account StreamingAccount? @relation(fields: [accountId], references: [id], onDelete: SetNull)
  sale    StreamingSale?    @relation(fields: [saleId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([companyId])
  @@index([itemId])
  @@index([type])
  @@index([refType])
  @@index([accountId])
  @@index([saleId])
  @@map("kardex_movements")
}
